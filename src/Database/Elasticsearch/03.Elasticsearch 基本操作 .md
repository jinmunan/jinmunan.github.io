---
icon: page
order: 3
---
# 倒排索引

正排索引（传统数据库）

| id   | content              |
| ---- | -------------------- |
| 1001 | my name is zhang san |
| 1002 | my name is li si     |

倒排索引

| keyword | id         |
| ------- | ---------- |
| name    | 1001, 1002 |
| zhang   | 1001       |

Elasticsearch 是面向文档型数据库，一条数据在这里就是一个文档。为了方便大家理解，我们将 Elasticsearch 里存储文档数据和关系型数据库 MySQL 存储数据的概念进行一个类比

![image-20230116140022556](https://cdn.staticaly.com/gh/jinmunan/imgs@master/Elasticsearch/image-20230116140022556.png)

ES 里的 Index 可以看做一个库，而 Types 相当于表，Documents 则相当于表的行。这里 Types 的概念已经被逐渐弱化，Elasticsearch 6.X 中，一个 index 下已经只能包含一个 type，Elasticsearch 7.X 中，Type 的概念已经被删除了。

## 创建索引

对比关系型数据库，创建索引就等同于创建数据库。

在 Postman 中，向 ES 服务器发 PUT 请求：

```json
PUT http://localhost:9200/shopping
```

服务器返回：

```json
{
    "acknowledged": true, //响应结果
    "shards_acknowledged": true, //分片结果
    "index": "shopping" //索引名称
}
```

如果重复发 PUT 请求：http://127.0.0.1:9200/shopping 添加索引，会返回错误信息 :

```json
{
    "error": {
        "root_cause": [
            {
                "type": "resource_already_exists_exception",
                "reason": "index [shopping/ZR8CpzHmTIiDYOdMtpKtkw] already exists",
                "index_uuid": "ZR8CpzHmTIiDYOdMtpKtkw",
                "index": "shopping"
            }
        ],
        "type": "resource_already_exists_exception",
        "reason": "index [shopping/ZR8CpzHmTIiDYOdMtpKtkw] already exists",
        "index_uuid": "ZR8CpzHmTIiDYOdMtpKtkw",
        "index": "shopping"
    },
    "status": 400
}
```

## 查询索引

### 查询索引

在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/shopping
```

服务器返回：

```json
{
    "shopping": {
        //索引名
        "aliases": {}, //别名
        "mappings": {}, //映射
        "settings": {
            //设置
            "index": {
                //设置 - 索引
                "creation_date": "1673855439736", //设置 - 索引 - 创建时间
                "number_of_shards": "1", //设置 - 索引 - 主分片数量
                "number_of_replicas": "1", //设置 - 索引 - 主分片数量
                "uuid": "ZR8CpzHmTIiDYOdMtpKtkw", //设置 - 索引 - 主分片数量
                "version": {
                    //设置 - 索引 - 主分片数量
                    "created": "7080099"
                },
                "provided_name": "shopping" //设置 - 索引 - 主分片数量
            }
        }
    }
}
```

### 查询所有索引

在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/_cat/indices?v
```

服务器返回：

```json
health status index    uuid                   pri rep docs.count docs.deleted store.size pri.store.size
yellow open   shopping ZR8CpzHmTIiDYOdMtpKtkw   1   1          0            0       208b           208b
```

| 表头           | 含义                                                                              |
| -------------- | --------------------------------------------------------------------------------- |
| health         | 当前服务器健康状态：green(集群完整) yellow(单点正常、集群不完整) red(单点不正常) |
| status         | 索引打开、关闭状态                                                                |
| index          | 索引名                                                                            |
| uuid           | 索引统一编号                                                                      |
| pri            | 主分片数量                                                                        |
| rep            | 副本数量                                                                          |
| docs.count     | 可用文档数量                                                                      |
| docs.deleted   | 文档删除状态（逻辑删除）                                                          |
| store.size     | 主分片和副分片整体占空间大小                                                      |
| pri.store.size | 主分片占空间大小                                                                  |

## 删除索引

在 Postman 中，向 ES 服务器发 DELETE 请求：

```json
DELETE http://localhost:9200/shopping
```

服务器返回：

```json
{
    "acknowledged": true
}
```

---

## 创建文档

假设索引已经创建好了，接下来我们来创建文档，并添加数据。这里的文档可以类比为关系型数据库中的表数据，添加的数据格式为 JSON 格式

在 Postman 中，向 ES 服务器发 POST 请求：

```json
POST http://localhost:9200/shopping/_doc
```

请求体 JSON 内容为：

```json
{
    "title": "小米手机",
    "category": "小米",
    "images": "http://www.gulixueyuan.com/xm.jpg",
    "price": 3999.0
}
```

服务器返回：

```json
{
    "_index": "shopping", //索引
    "_type": "_doc", //类型 - 文档
    "_id": "XHSQuYUB3s9YhFuAfppS", //唯一标识，可以类比为 MySQL 中的主键，随机生成
    "_version": 1, //版本
    "result": "created", //结果，这里的 create 表示创建成功
    "_shards": {
        //
        "total": 2, //分片 - 总数
        "successful": 1, //分片 - 总数
        "failed": 0 //分片 - 总数
    },
    "_seq_no": 0,
    "_primary_term": 1
}
```

上面的数据创建后，由于没有指定数据唯一性标识（ID），默认情况下，ES 服务器会随机生成一个。

如果想要自定义唯一性标识，需要在创建时指定：

```java
POST http://localhost:9200/shopping/_doc/1001
```

> 注意：
>
> 发送请求的方式必须为 POST，不能是 PUT，因为每次添加数据都会自动生成一个随机主键。POST 没有幂等性，所有可以使用，PUT 幂等性，除非保证每次生成的 ID 是同一个，否则不能使用。
>
> 如果添加数据能确定自定义唯一性标识，则可以使用 PUT 添加数据。

## 查询文档

### 主键查询

在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/shopping/_doc/1001
```

服务器返回：

```json
{
    "_index": "shopping", //索引
    "_type": "_doc", //文档类型
    "_id": "1001",
    "_version": 2,
    "_seq_no": 2,
    "_primary_term": 1,
    "found": true, //查询结果 true 表示查找到，false 表示未查找到
    "_source": {
        //文档源信息
         "title": "小米手机",
        "category": "小米",
        "images": "http://www.gulixueyuan.com/xm.jpg",
        "price": 3999.0
    }
}
```

### 全查询

查看索引下所有数据，在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/shopping/_search
```

服务器返回：

```json
{
    "took": 4,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 2,
            "relation": "eq"
        },
        "max_score": 1.0,
        "hits": [
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "XHSQuYUB3s9YhFuAfppS",
                "_score": 1.0,
                "_source": {
                    "title": "小米手机",
                    "category": "小米",
                    "images": "http://www.gulixueyuan.com/xm.jpg",
                    "price": 3999.0
                }
            },
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1001",
                "_score": 1.0,
                "_source": {
                    "title": "小米手机",
                    "category": "小米",
                    "images": "http://www.gulixueyuan.com/xm.jpg",
                    "price": 3999.0
                }
            }
        ]
    }
}
```

## 修改文档

### 全量修改

和新增文档一样，输入相同的 URL 地址请求，如果请求体变化，会将原有的数据内容覆盖。

在 Postman 中，向 ES 服务器发 POST 请求：

```json
PUT http://localhost:9200/shopping/_doc/1001
```

请求体 JSON 内容为：

```json
{
    "title": "小米手机",
    "category": "小米",
    "images": "http://www.gulixueyuan.com/xm.jpg",
    "price": 4999.0
}
```

服务器返回：

```json
{
    "_index": "shopping",
    "_type": "_doc",
    "_id": "1001",
    "_version": 3,
    "result": "updated", //<-----------updated 表示数据被更新
    "_shards": {
        "total": 2,
        "successful": 1,
        "failed": 0
    },
    "_seq_no": 3,
    "_primary_term": 1
}
```

### 局部修改

修改数据时，也可以只修改某一给条数据的局部信息

在 Postman 中，向 ES 服务器发 POST 请求：

```json
POST http://localhost:9200/shopping/_update/1001
```

请求体 JSON 内容为：

```json
{
    "doc": {
        "title": "华为手机",
        "category": "华为"
    }
}
```

服务器返回：

```json
{
    "_index": "shopping",
    "_type": "_doc",
    "_id": "1001",
    "_version": 4,
    "result": "updated", //<-----------updated 表示数据被更新
    "_shards": {
        "total": 2,
        "successful": 1,
        "failed": 0
    },
    "_seq_no": 4,
    "_primary_term": 1
}
```

## 删除文档

删除一个文档不会立即从磁盘上移除，它只是被标记成已删除（逻辑删除）。

在 Postman 中，向 ES 服务器发 DELETE 请求：

```json
DELETE http://localhost:9200/shopping/_doc/XHSQuYUB3s9YhFuAfppS
```

服务器返回：

```json
{
    "_index": "shopping",
    "_type": "_doc",
    "_id": "XHSQuYUB3s9YhFuAfppS",
    "_version": 2,
    "result": "deleted", //<---删除成功
    "_shards": {
        "total": 2,
        "successful": 1,
        "failed": 0
    },
    "_seq_no": 5,
    "_primary_term": 1
}
```

## 条件查询

### 条件查询

> 注意：
>
> 查找 category 为小米的文档，在 Postman 中，向 ES 服务器发 GET 请求：
>
> ```json
> GET http://127.0.0.1:9200/shopping/_search?q=category:小米
> ```
>
> 上述为 URL 带参数形式查询，这很容易让不善者心怀恶意，或者参数值出现中文会出现乱码情况。为了避免这些情况，我们可用使用带 JSON 请求体请求进行查询。

在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/shopping/_search
```

请求体 JSON 内容为：

```json
{
    "query": {
        //查询
        "match": {
            //匹配
            "category": "小米" //条件
        }
    }
}
```

服务器返回：

```json
{
    "took": 4,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 1,
            "relation": "eq"
        },
        "max_score": 0.5753642,
        "hits": [
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1002",
                "_score": 0.5753642,
                "_source": {
                    "title": "小米手机",
                    "category": "小米",
                    "images": "http://www.gulixueyuan.com/xm.jpg",
                    "price": 3999.0
                }
            }
        ]
    }
}
```

### 查询指定字段

如果你想查询指定字段，在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/shopping/_search
```

请求体 JSON 内容为：

```json
{
    "query": {
        "match_all": {}
    },
    "_source": ["title"]
}
```

服务器返回：

```json
{
    "took": 3,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 2,
            "relation": "eq"
        },
        "max_score": 1.0,
        "hits": [
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1001",
                "_score": 1.0,
                "_source": {
                    "title": "华为手机"
                }
            },
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1002",
                "_score": 1.0,
                "_source": {
                    "title": "小米手机"
                }
            }
        ]
    }
}
```

### 分页查询

在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/shopping/_search
```

请求体 JSON 内容为：

```json
{
    "query": {
        "match_all": {}
    },
    "from": 0,
    "size": 2
}
```

服务器返回：

```json
{
    "took": 7,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 2,
            "relation": "eq"
        },
        "max_score": 1.0,
        "hits": [
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1001",
                "_score": 1.0,
                "_source": {
                    "title": "华为手机",
                    "category": "华为",
                    "images": "http://www.gulixueyuan.com/xm.jpg",
                    "price": 4999.0
                }
            },
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1002",
                "_score": 1.0,
                "_source": {
                    "title": "小米手机",
                    "category": "小米",
                    "images": "http://www.gulixueyuan.com/xm.jpg",
                    "price": 3999.0
                }
            }
        ]
    }
}
```

### 排序查询

如果你想通过排序查出价格最高的手机，在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/shopping/_search
```

请求体 JSON 内容为：

```json
{
    "query": {
        "match_all": {}
    },
    "sort": {
        "price": {
            "order": "desc"
        }
    }
}
```

服务器返回：

```json
{
    "took": 26,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 2,
            "relation": "eq"
        },
        "max_score": null,
        "hits": [
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1001",
                "_score": null,
                "_source": {
                    "title": "华为手机",
                    "category": "华为",
                    "images": "http://www.gulixueyuan.com/xm.jpg",
                    "price": 4999.0
                },
                "sort": [
                    4999.0
                ]
            },
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1002",
                "_score": null,
                "_source": {
                    "title": "小米手机",
                    "category": "小米",
                    "images": "http://www.gulixueyuan.com/xm.jpg",
                    "price": 3999.0
                },
                "sort": [
                    3999.0
                ]
            }
        ]
    }
}
```

### 多条件查询

#### must 条件

假设想找出小米牌子，价格为 3999 元的。（must 相当于数据库的&&）

在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/shopping/_search
```

请求体 JSON 内容为：

```json
{
    "query": {
        "bool": {
            //多条件查询
            "must": [
                //多个条件同时成立
                {
                    "match": {
                        "category": "小米"
                    }
                },
                {
                    "match": {
                        "price": "3999.00"
                    }
                }
            ]
        }
    }
}
```

服务器返回：

```json
{
    "took": 9,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 1,
            "relation": "eq"
        },
        "max_score": 1.5753641,
        "hits": [
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1002",
                "_score": 1.5753641,
                "_source": {
                    "title": "小米手机",
                    "category": "小米",
                    "images": "http://www.gulixueyuan.com/xm.jpg",
                    "price": 3999.0
                }
            }
        ]
    }
}
```

#### should 条件

假设想找出小米和华为的牌子。（should 相当于数据库的||）

在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/shopping/_search
```

请求体 JSON 内容为：

```json
{
    "query": {
        "bool": {
            "should": [
                {
                    "match": {
                        "category": "小米"
                    }
                },
                {
                    "match": {
                        "category": "华为"
                    }
                }
            ]
        }
    }
}
```

服务器返回：

```json
{
    "took": 3,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 2,
            "relation": "eq"
        },
        "max_score": 2.7725885,
        "hits": [
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1001",
                "_score": 2.7725885,
                "_source": {
                    "title": "华为手机",
                    "category": "华为",
                    "images": "http://www.gulixueyuan.com/xm.jpg",
                    "price": 4999.0
                }
            },
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1002",
                "_score": 0.5753642,
                "_source": {
                    "title": "小米手机",
                    "category": "小米",
                    "images": "http://www.gulixueyuan.com/xm.jpg",
                    "price": 3999.0
                }
            }
        ]
    }
}
```

### 范围查询

假设想找出小米和华为的牌子，价格大于 2000 元的手机。

在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/shopping/_search
```

请求体 JSON 内容为：

```json
{
    "query": {
        "bool": {
            "should": [
                {
                    "match": {
                        "category": "小米"
                    }
                },
                {
                    "match": {
                        "category": "华为"
                    }
                }
            ],
            "filter": {
                "range": {
                    "price": {
                        "gt": 2000
                    }
                }
            }
        }
    }
}
```

服务器返回：

```json
{
    "took": 7,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 2,
            "relation": "eq"
        },
        "max_score": 2.7725885,
        "hits": [
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1001",
                "_score": 2.7725885,
                "_source": {
                    "title": "华为手机",
                    "category": "华为",
                    "images": "http://www.gulixueyuan.com/xm.jpg",
                    "price": 4999.0
                }
            },
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1002",
                "_score": 0.5753642,
                "_source": {
                    "title": "小米手机",
                    "category": "小米",
                    "images": "http://www.gulixueyuan.com/xm.jpg",
                    "price": 3999.0
                }
            }
        ]
    }
}
```

### 全文检索匹配

这功能像搜索引擎那样，如品牌输入“小华”，返回结果带回品牌有“小米”和“华为“的。因为条件“小华”被分词成“小”和“华”了，再通过倒排索引可以找到“小米”和“华为“ 。

在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/shopping/_search
```

请求体 JSON 内容为：

```json
{
    "query": {
        "match": {
            "category": "小华"
        }
    }
}
```

服务器返回：

```json
{
    "took": 2,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 2,
            "relation": "eq"
        },
        "max_score": 1.3862942,
        "hits": [
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1001",
                "_score": 1.3862942,
                "_source": {
                    "title": "华为手机",
                    "category": "华为",
                    "images": "http://www.gulixueyuan.com/xm.jpg",
                    "price": 4999.0
                }
            },
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1002",
                "_score": 0.2876821,
                "_source": {
                    "title": "小米手机",
                    "category": "小米",
                    "images": "http://www.gulixueyuan.com/xm.jpg",
                    "price": 3999.0
                }
            }
        ]
    }
}
```

### 完全匹配

在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/shopping/_search
```

请求体 JSON 内容为：

```json
{
    "query": {
        "match_phrase": {
            "category": "为"
        }
    }
}
```

服务器返回：

```json
{
    "took": 1,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 1,
            "relation": "eq"
        },
        "max_score": 1.3862942,
        "hits": [
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1001",
                "_score": 1.3862942,
                "_source": {
                    "title": "华为手机",
                    "category": "华为",
                    "images": "http://www.gulixueyuan.com/xm.jpg",
                    "price": 4999.0
                }
            }
        ]
    }
}
```

### 高亮查询

在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/shopping/_search
```

请求体 JSON 内容为：

```json
{
    "query": {
        "match_phrase": {
            "category": "米"
        }
    },
    "highlight": {
        "fields": {
            "category": {} //<----高亮这字段
        }
    }
}
```

服务器返回：

```json
{
    "took": 3,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 1,
            "relation": "eq"
        },
        "max_score": 0.2876821,
        "hits": [
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1002",
                "_score": 0.2876821,
                "_source": {
                    "title": "小米手机",
                    "category": "小米",
                    "images": "http://www.gulixueyuan.com/xm.jpg",
                    "price": 3999.0
                },
                "highlight": {
                    "category": [
                        "小<em>米</em>"  //<----高亮这字段
                    ]
                }
            }
        ]
    }
}
```

### 聚合查询

聚合允许使用者对 ES 文档进行统计分析，类似与关系型数据库中的 group by，当然还有很多其他的聚合，例如取最大值 max、平均值 avg 等等。

接下来按 price 字段进行分组：

在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/shopping/_search
```

请求体 JSON 内容为：

```json
{
    "aggs": {
        //聚合
        "price_group": {
            //分组名称随便取
            "terms": {
                "field": "price"
            }
        }
    }
}
```

服务器返回：

```json
{
    "took": 23,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 2,
            "relation": "eq"
        },
        "max_score": 1.0,
        "hits": [
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1001",
                "_score": 1.0,
                "_source": {
                    "title": "华为手机",
                    "category": "华为",
                    "images": "http://www.gulixueyuan.com/xm.jpg",
                    "price": 4999.0
                }
            },
            {
                "_index": "shopping",
                "_type": "_doc",
                "_id": "1002",
                "_score": 1.0,
                "_source": {
                    "title": "小米手机",
                    "category": "小米",
                    "images": "http://www.gulixueyuan.com/xm.jpg",
                    "price": 3999.0
                }
            }
        ]
    },
    "aggregations": {
        "price_group": {
            "doc_count_error_upper_bound": 0,
            "sum_other_doc_count": 0,
            "buckets": [
                {
                    "key": 3999.0,
                    "doc_count": 1
                },
                {
                    "key": 4999.0,
                    "doc_count": 1
                }
            ]
        }
    }
}
```

上面返回结果会附带原始数据的。若不想要不附带原始数据的结果，修改请求体 JSON 内容

请求体 JSON 内容为：

```json
{
    "aggs": {
        //聚合
        "price_group": {
            //分组名称随便取
            "terms": {
                "field": "price"
            }
        }
    },
    "size": 0 //查看统计数据
}
```

服务器返回：

```json
{
    "took": 7,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 2,
            "relation": "eq"
        },
        "max_score": null,
        "hits": []
    },
    "aggregations": {
        "price_group": {
            "doc_count_error_upper_bound": 0,
            "sum_other_doc_count": 0,
            "buckets": [
                {
                    "key": 3999.0,
                    "doc_count": 1
                },
                {
                    "key": 4999.0,
                    "doc_count": 1
                }
            ]
        }
    }
}
```

## 映射关系

创建数据库表需要设置字段名称，类型，长度，约束等；索引库也一样，需要知道这个类型下有哪些字段，每个字段有哪些约束信息，这就叫做映射 (mapping).

### 创建索引

在 Postman 中，向 ES 服务器发 PUT 请求：

```json
PUT http://localhost:9200/user
```

服务器返回：

```json
{
    "acknowledged": true,
    "shards_acknowledged": true,
    "index": "user"
}
```

### 创建映射

在 Postman 中，向 ES 服务器发 PUT 请求：

```json
PUT http://localhost:9200/user/_mapping
```

请求体 JSON 内容为：

```json
{
    "properties": {
        "name":{
            "type":"text", // 可以被分词
            "index":true
        },
        "sex":{
            "type":"keyword",
            "index":true
        },
        "tel":{
            "type":"keyword",
            "index":false
        }
    }
}
```

服务器返回：

```json
{
    "acknowledged": true
}
```

### 查询映射

在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/user/_mapping
```

服务器返回：

```json
{
    "user": {
        "mappings": {
            "properties": {
                "name": {
                    "type": "text"
                },
                "sex": {
                    "type": "keyword"
                },
                "tes": {
                    "type": "keyword",
                    "index": false
                }
            }
        }
    }
}
```

### 添加文档

在 Postman 中，向 ES 服务器发 PUT 请求：

```json
PUT http://localhost:9200/user/_create/1001
```

请求体 JSON 内容为：

```json
{
	"name":"小米",
	"sex":"男的",
	"tel":"1111"
}
```

服务器返回：

```json
{
    "_index": "user",
    "_type": "_doc",
    "_id": "1001",
    "_version": 1,
    "result": "created",
    "_shards": {
        "total": 2,
        "successful": 1,
        "failed": 0
    },
    "_seq_no": 0,
    "_primary_term": 1
}
```

### 查找 name 含有”小“数据

在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/user/_search
```

请求体 JSON 内容为：

```json
{
	"query":{
		"match":{
			"name":"小"
		}
	}
}
```

服务器返回：

```json
{
    "took": 2,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 1,
            "relation": "eq"
        },
        "max_score": 0.2876821,
        "hits": [
            {
                "_index": "user",
                "_type": "_doc",
                "_id": "1001",
                "_score": 0.2876821,
                "_source": {
                    "name": "小米",
                    "sex": "男的",
                    "tel": "1111"
                }
            }
        ]
    }
}
```

### 查找 sex 含有”男“数据：

在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/user/_search
```

请求体 JSON 内容为：

```json
{
	"query":{
		"match":{
			"sex":"男"
		}
	}
}
```

服务器返回：

<mark>没有返回数据，因为 sex 是关键字类型，不能通过分词查找</mark>

```json
{
    "took": 1,
    "timed_out": false,
    "_shards": {
        "total": 1,
        "successful": 1,
        "skipped": 0,
        "failed": 0
    },
    "hits": {
        "total": {
            "value": 0,
            "relation": "eq"
        },
        "max_score": null,
        "hits": []
    }
}
```

### 查询电话

在 Postman 中，向 ES 服务器发 GET 请求：

```json
GET http://localhost:9200/user/_search
```

请求体 JSON 内容为：

```json
{
	"query":{
		"match":{
			"tel":"11"
		}
	}
}
```

服务器返回：

<mark>因为创建映射时"tel"的"index"为 false，所以报错</mark>

```json
{
    "error": {
        "root_cause": [
            {
                "type": "query_shard_exception",
                "reason": "failed to create query: Cannot search on field [tes] since it is not indexed.",
                "index_uuid": "lCTOe8RfT0mdGn6HE6yoOA",
                "index": "user"
            }
        ],
        "type": "search_phase_execution_exception",
        "reason": "all shards failed",
        "phase": "query",
        "grouped": true,
        "failed_shards": [
            {
                "shard": 0,
                "index": "user",
                "node": "_cGMHOZYRqa4eJKnkxs23g",
                "reason": {
                    "type": "query_shard_exception",
                    "reason": "failed to create query: Cannot search on field [tel] since it is not indexed.",
                    "index_uuid": "lCTOe8RfT0mdGn6HE6yoOA",
                    "index": "user",
                    "caused_by": {
                        "type": "illegal_argument_exception",
                        "reason": "Cannot search on field [tel] since it is not indexed."
                    }
                }
            }
        ]
    },
    "status": 400
}
```

