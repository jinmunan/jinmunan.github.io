---
icon: page
order: 4
---
# 游标的使用

## 游标概念

游标是一种在 PL/SQL 中常用的数据结构，它可以对一个 SELECT 语句返回的结果集进行操作。游标可以被看作是一个指针，指向一个 SELECT 语句返回的结果集中的一条记录。通过游标，我们可以遍历结果集中的每一条记录，并对其进行处理。

在 PL/SQL 中，游标主要包括显式游标和隐式游标两种类型。

## 显式游标

显式游标是用户定义的一种游标，它需要通过 OPEN、FETCH 和 CLOSE 三个关键字来实现。显式游标需要先定义一个游标变量，然后使用 OPEN 语句打开游标，使用 FETCH 语句获取游标指向的记录，最后使用 CLOSE 语句关闭游标。

显式游标的主要步骤如下：

- 定义游标变量：使用 DECLARE 语句定义一个游标变量，并且指定 SELECT 语句的返回结果类型。
- 打开游标：使用 OPEN 语句打开游标，并将游标指向结果集中的第一条记录。
- 获取记录：使用 FETCH 语句获取游标指向的记录，并将游标指向结果集中的下一条记录。
- 关闭游标：使用 CLOSE 语句关闭游标。

```sql
DECLARE
  CURSOR cursor_name IS
    SELECT columns FROM table;
  -- 声明游标
BEGIN
  OPEN cursor_name;
  -- 打开游标
  LOOP
    FETCH cursor_name INTO variables;
    -- 读取数据
    EXIT WHEN cursor_name%NOTFOUND;
  END LOOP;
  CLOSE cursor_name;
  -- 关闭游标
END;
```

其中，`cursor_name` 是游标的名称，`SELECT columns FROM table` 是游标的查询语句，`variables` 是游标读取数据时存储数据的变量。

### ①查询前 10 名员工的信息

```sql
DECLARE
  -- 定义游标变量
  CURSOR emp_cursor IS
    SELECT * FROM emp
    ORDER BY sal DESC
    FETCH FIRST 10 ROWS ONLY;

  -- 定义变量存储员工信息
  emp_rec emp%ROWTYPE;

BEGIN
  -- 打开游标
  OPEN emp_cursor;

  -- 获取员工信息
  LOOP
    FETCH emp_cursor INTO emp_rec;
    EXIT WHEN emp_cursor%NOTFOUND;
    -- 处理员工信息
    DBMS_OUTPUT.PUT_LINE(emp_rec.empno || ' ' || emp_rec.ename || ' ' || emp_rec.sal);
  END LOOP;

  -- 关闭游标
  CLOSE emp_cursor;
END;
```

以上代码使用 FETCH FIRST 10 ROWS ONLY 子句来限制查询结果的数量，保证只返回前 10 名员工的信息。在循环中使用 FETCH 语句获取每一条员工信息，并使用 %NOTFOUND 属性来判断游标是否到达了结果集的末尾。在获取到每一条员工信息后，可以根据需要对其进行处理。最后使用 CLOSE 语句关闭游标。

### ②遍历 emp 表中所有员工信息

```sql
DECLARE
  -- 定义游标变量
  CURSOR emp_cursor IS
    SELECT * FROM emp;

  -- 定义变量存储员工信息
  emp_rec emp%ROWTYPE;

BEGIN
  -- 打开游标
  OPEN emp_cursor;

  -- 获取员工信息
  LOOP
    FETCH emp_cursor INTO emp_rec;
    EXIT WHEN emp_cursor%NOTFOUND;
    -- 处理员工信息
    DBMS_OUTPUT.PUT_LINE(emp_rec.empno || ' ' || emp_rec.ename);
  END LOOP;

  -- 关闭游标
  CLOSE emp_cursor;
END;
```

在上面的例子中，首先定义了一个游标变量 emp_cursor，它指向 emp 表的所有记录。然后使用 OPEN 语句打开游标，并将游标指向结果集中的第一条记录。在循环中使用 FETCH 语句获取每一条员工信息，并使用 %NOTFOUND 属性来判断游标是否到达了结果集的末尾。在获取到每一条员工信息。

## 隐式游标

隐式游标是 Oracle 数据库自动创建和管理的一种游标，它通常用于存储当前执行 SQL 语句返回的结果集。

隐式游标的使用方式很简单，只需要在 SQL 语句中使用 SELECT INTO 语句将查询结果存储到指定变量中即可。Oracle 数据库会自动将结果集存储到隐式游标中，并将游标指向结果集中的第一条记录。

### ①查询前 10 名员工的信息

```sql,[13]
DECLARE
  -- 定义变量存储员工信息
  emp_rec emp%ROWTYPE;

BEGIN
  -- 查询前 10 名员工信息
  SELECT * INTO emp_rec
  FROM (
    SELECT *
    FROM emp
    ORDER BY sal DESC
  )
  WHERE ROWNUM <= 1;

  -- 输出查询结果
  DBMS_OUTPUT.PUT_LINE(emp_rec.empno || ' ' || emp_rec.ename || ' ' || emp_rec.sal);
END;
```

在上面的例子中，首先定义了一个 emp_rec 变量，用于存储查询结果中的每一条记录。然后使用 SELECT INTO 语句查询 emp 表中薪水最高的前 10 名员工信息，并将查询结果存储到 emp_rec 变量中。最后使用 DBMS_OUTPUT.PUT_LINE 函数将查询结果输出到控制台中。

需要注意的是，隐式游标在 SELECT INTO 语句中只能返回一条记录，因此如果查询结果包含多条记录，则会抛出 TOO_MANY_ROWS 异常。如果查询结果为空，则会抛出 NO_DATA_FOUND 异常。因此，在使用隐式游标时需要确保查询结果只包含一条记录。

#### 报错说明

`exact fetch returns more than requested number of rows ORA-06512: at line X` 错误通常是由于在使用 `SELECT INTO` 语句时，查询结果包含了多条记录，但是 `INTO` 子句只能接收一条记录，因此会抛出此异常。

解决方法是确保查询结果只包含一条记录。有以下几种方法：

1. 使用 WHERE 子句过滤掉多余的记录。
2. 使用 LIMIT 子句限制查询结果的数量，确保只有一条记录。
3. 使用游标进行逐条处理。

## 游标的属性和方法

1. 游标属性

- `%FOUND`：返回布尔值，表示最近一次 fetch 操作是否检索到任何行。
- `%NOTFOUND`：返回布尔值，表示最近一次 fetch 操作是否未检索到任何行。
- `%ROWCOUNT`：返回最近一次 fetch 操作检索到的行数。
- `%ISOPEN`：返回布尔值，表示游标是否处于打开状态。

1. 游标方法

- `OPEN`：打开游标。
- `FETCH`：检索下一行。
- `CLOSE`：关闭游标。

下面是针对 emp 表的一些示例：

```sql
DECLARE
  CURSOR emp_cursor IS
    SELECT * FROM emp;
  
  emp_rec emp%ROWTYPE;
BEGIN
  OPEN emp_cursor;
  
  IF emp_cursor%ISOPEN THEN
    DBMS_OUTPUT.PUT_LINE('The cursor is open');
  ELSE
    DBMS_OUTPUT.PUT_LINE('The cursor is not open');
  END IF;
  
  FETCH emp_cursor INTO emp_rec;
  IF emp_cursor%FOUND THEN
    DBMS_OUTPUT.PUT_LINE('Employee ' || emp_rec.ename || ' found');
  ELSE
    DBMS_OUTPUT.PUT_LINE('Employee not found');
  END IF;
  
  IF emp_cursor%NOTFOUND THEN
    DBMS_OUTPUT.PUT_LINE('No more employees found');
  END IF;
  
  IF emp_cursor%ROWCOUNT = 0 THEN
    DBMS_OUTPUT.PUT_LINE('No rows were fetched');
  ELSE
    DBMS_OUTPUT.PUT_LINE('Number of rows fetched: ' || emp_cursor%ROWCOUNT);
  END IF;
  
  CLOSE emp_cursor;
END;
```

在这个示例中，我们定义了一个名为 emp_cursor 的游标，该游标可以检索 emp 表的所有行。然后，我们打开游标并使用 `%ISOPEN` 属性检查它是否打开。接下来，我们使用 `FETCH` 方法检索第一行，并使用 `%FOUND` 和 `%NOTFOUND` 属性检查是否检索到了行。最后，我们使用 `%ROWCOUNT` 属性确定已检索的行数。最后，我们关闭游标。

注意：这只是游标属性和方法的一个简单示例。实际上，游标可以进行更复杂的操作，例如使用 `FOR LOOP` 循环语句进行迭代等等。
