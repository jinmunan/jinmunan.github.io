---
icon: page
order: 6
---
# 本地镜像推送到私有库

## 什么是 Docker Registry

官方 Docker Hub 地址：[https://hub.docker.com/](https://hub.docker.com/)，中国大陆访问太慢了且准备被阿里云取代的趋势，不太主流。

Dockerhub、阿里云这样的公共镜像仓库可能不太方便，涉及机密的公司不可能提供镜像给公网，所以需要创建一个本地私人仓库供给团队使用，基于公司内部项目构建镜像。

Docker Registry 是官方提供的工具，可以用于构建私有镜像仓库

## 将本地镜像推送到私有库案例

### 下载私有库并运行

```sh
# 下载镜像Docker Registry
docker pull registry

# 运行私有库Registry，相当于本地有个私有库Docker Hub
docker run -d -p 5000:5000 -v /zhongnan/registry/:/tmp/registry --privileged=true registry

# 默认情况，仓库被创建在容器的/var/lib/registry目录下，建议自行用容器卷映射，方便于宿主机联调
[root@jinmunan ~]# docker run -d -p 5000:5000 -v /zzyyuse/myregistry/:/tmp/registry --privileged=true registry
f6e0f73d23f3888f47fce698a4811a317d422df487c4f813369984fee73ffd36
[root@jinmunan ~]# docker ps
CONTAINER ID   IMAGE      COMMAND                  CREATED          STATUS          PORTS                                       NAMES
f6e0f73d23f3   registry   "/entrypoint.sh /etc…"   48 seconds ago   Up 47 seconds   0.0.0.0:5000->5000/tcp, :::5000->5000/tcp   charming_cori
```

### 创建 ubuntu 新镜像并推送

```sh
# 回顾 重新进入正在运行的容器
docker exec -it 5a7f101f8925 /bin/bash
 
# 案例演示创建一个新镜像，ubuntu安装ifconfig命令
apt-get install net-tools

# 在不关闭容器的基础上退出容器
ctrl+p+q

# 封装镜像
docker commit -m="new ubuntu" -a="zhongnan" 41d9290eff93 zhongnan/myubuntu:1.3

# curl验证私服库上有什么镜像
curl -XGET http://193.111.30.163:5000/v2/_catalog
{"repositories":[]}

# 将新镜像myubuntu:1.3修改符合私服规范的Tag
# docker tag 镜像:Tag Host:Port/Repository:Tag
docker tag zhongnan/myubuntu:1.3 193.111.30.163:5000/myubuntu:1.3

# 上述理由：docker默认不允许http方式推送镜像，通过配置选项来取消这个限制。修改完后如果不生效，建议重启docker
# vim命令新增如下红色内容：
vim /etc/docker/daemon.json

{
  "registry-mirrors": ["https://aa25jngu.mirror.aliyuncs.com"],
  "insecure-registries": ["193.111.30.163:5000"]
}

# 重启 docker
systemctl daemon-reload
systemctl restart docker

# 推送到私服库
docker push 193.111.30.163:5000/myubuntu:1.3

# 验证
[root@jinmunan docker]# curl -XGET http://193.111.30.163:5000/v2/_catalog
{"repositories":["myubuntu"]}
```

### pull 到本地并运行

```sh
docker pull 193.111.30.163:5000/myubuntu:1.3

[root@jinmunan ~]# docker pull 193.111.30.163:5000/myubuntu:1.3
1.3: Pulling from myubuntu
7b1a6ab2e44d: Already exists 
4e35a73f3dfe: Pull complete 
Digest: sha256:c9c1adcf644469eb82a9790b422fc4ebef248acfaf2304fc5046cd716a181845
Status: Downloaded newer image for 193.111.30.163:5000/myubuntu:1.3
193.111.30.163:5000/myubuntu:1.3
[root@jinmunan ~]# docker images
REPOSITORY                     TAG       IMAGE ID       CREATED              SIZE
193.111.30.163:5000/myubuntu   1.3       d2e3fc0d559c   About a minute ago   182MB
registry                       latest    b8604a3fe854   15 months ago        26.2MB
ubuntu                         latest    ba6acccedd29   16 months ago        72.8MB
```

